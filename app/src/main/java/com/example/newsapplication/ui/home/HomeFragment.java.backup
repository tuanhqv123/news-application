package com.example.newsapplication.ui.home;

import android.content.Intent;
import android.os.Bundle;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.Toast;

import androidx.annotation.NonNull;
import androidx.fragment.app.Fragment;
import androidx.lifecycle.ViewModelProvider;
import androidx.recyclerview.widget.GridLayoutManager;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;

import com.example.newsapplication.ArticleDetailActivity;
import com.example.newsapplication.MainActivity;
import com.example.newsapplication.R;
import com.example.newsapplication.adapter.breaking.BreakingNewsAdapter;
import com.example.newsapplication.adapter.NewsAdapter;
import com.example.newsapplication.databinding.FragmentHomeBinding;
import com.example.newsapplication.model.Article;
import com.example.newsapplication.data.MockDataProvider;
import com.example.newsapplication.auth.UserSessionManager;
import com.example.newsapplication.auth.AuthService;
import com.example.newsapplication.repository.NewsRepository;
import org.json.JSONObject;
import org.json.JSONArray;

import java.util.ArrayList;
import java.util.List;

public class HomeFragment extends Fragment {

    private FragmentHomeBinding binding;
    private NewsAdapter newsAdapter;
    private BreakingNewsAdapter breakingNewsAdapter;
    private RecyclerView breakingNewsRecyclerView;
    private RecyclerView popularNewsRecyclerView;
    private List<Article> breakingNewsList;
    private List<Article> popularNewsList;
    private MockDataProvider mockDataProvider;
    private String currentSource = "VnExpress";
    private UserSessionManager sessionManager;
    private AuthService authService;
    private NewsRepository newsRepository;

    public View onCreateView(@NonNull LayoutInflater inflater,
                             ViewGroup container, Bundle savedInstanceState) {
        HomeViewModel homeViewModel =
                new ViewModelProvider(this).get(HomeViewModel.class);

        binding = FragmentHomeBinding.inflate(inflater, container, false);
        View root = binding.getRoot();

        sessionManager = new UserSessionManager(getContext());
        authService = new AuthService(getContext());
        newsRepository = new NewsRepository(getContext());
        setupRecyclerViews();
        loadMockNews();
        
        // Update user avatar if logged in
        updateUserInfo();
        setupTabNavigation();
        setupHeaderClicks();

        // Handle see more click
        try {
            binding.seeMoreTextView.setOnClickListener(v -> {
                Toast.makeText(getContext(), "See more breaking news", Toast.LENGTH_SHORT).show();
            });
        } catch (Exception e) {
            e.printStackTrace();
        }

        return root;
    }

    private void setupHeaderClicks() {
        // User avatar click - navigate to profile if logged in, show login if not
        binding.userAvatar.setOnClickListener(v -> {
            if (sessionManager.isLoggedIn()) {
                // Navigate to profile fragment
                if (getActivity() instanceof MainActivity) {
                    MainActivity mainActivity = (MainActivity) getActivity();
                    mainActivity.navigateToProfile();
                }
            } else {
                // Show login dialog
                if (getActivity() instanceof MainActivity) {
                    MainActivity mainActivity = (MainActivity) getActivity();
                    mainActivity.showLoginDialog();
                }
            }
        });

        // Notification icon click
        binding.notificationIcon.setOnClickListener(v -> {
            Toast.makeText(getContext(), "Notifications clicked", Toast.LENGTH_SHORT).show();
        });
    }

    private void setupTabNavigation() {
        // Feeds tab click
        binding.feedsTab.setOnClickListener(v -> {
            updateTabSelection(binding.feedsTab);
            loadFeedsContent();
        });

        // Popular tab click
        binding.popularTab.setOnClickListener(v -> {
            updateTabSelection(binding.popularTab);
            loadPopularContent();
        });

        // Following tab click
        binding.followingTab.setOnClickListener(v -> {
            updateTabSelection(binding.followingTab);
            loadFollowingContent();
        });

        // Set default tab to Popular
        updateTabSelection(binding.popularTab);
    }

    private void updateUserInfo() {
        if (sessionManager.isLoggedIn()) {
            String userName = sessionManager.getUserName();
            String email = sessionManager.getUserEmail();
            
            // Show user name in header
            binding.userNameTextView.setText(userName.isEmpty() ? email.split("@")[0] : userName);
        } else {
            // Show generic user info
            binding.userNameTextView.setText("Guest User");
        }
    }

    private void updateTabSelection(android.view.View selectedTab) {
        // Reset all tabs to unselected state
        binding.feedsTab.setBackgroundResource(R.drawable.tab_background);
        binding.feedsTab.setTextColor(getResources().getColor(android.R.color.black));

        binding.popularTab.setBackgroundResource(R.drawable.tab_background);
        binding.popularTab.setTextColor(getResources().getColor(android.R.color.black));

        binding.followingTab.setBackgroundResource(R.drawable.tab_background);
        binding.followingTab.setTextColor(getResources().getColor(android.R.color.black));

        // Highlight selected tab with rounded background
        selectedTab.setBackgroundResource(R.drawable.tab_selected_background);
        if (selectedTab.getId() == R.id.feedsTab) {
            binding.feedsTab.setTextColor(android.graphics.Color.WHITE);
        } else if (selectedTab.getId() == R.id.popularTab) {
            binding.popularTab.setTextColor(android.graphics.Color.WHITE);
        } else if (selectedTab.getId() == R.id.followingTab) {
            binding.followingTab.setTextColor(android.graphics.Color.WHITE);
        }
    }

    private void loadFeedsContent() {
        Toast.makeText(getContext(), "Loading Feeds content", Toast.LENGTH_SHORT).show();
        loadBreakingNews();
    }

    private void loadPopularContent() {
        Toast.makeText(getContext(), "Loading Popular content", Toast.LENGTH_SHORT).show();
        loadPopularNews();
    }

    private void loadFollowingContent() {
        Toast.makeText(getContext(), "Loading Following content", Toast.LENGTH_SHORT).show();
        // Load following content
        if (mockDataProvider != null) {
            List<Article> articles = mockDataProvider.getPopularNews();
            popularNewsList.clear();
            popularNewsList.addAll(articles.subList(0, Math.min(6, articles.size())));
            newsAdapter.notifyDataSetChanged();
        }
    }

    private void setupRecyclerViews() {
        try {
            // Breaking News RecyclerView
            breakingNewsRecyclerView = binding.breakingNewsRecyclerView;
            breakingNewsList = new ArrayList<>();
            breakingNewsAdapter = new BreakingNewsAdapter(breakingNewsList, article -> {
                openArticleDetail(article);
            });
            breakingNewsRecyclerView.setLayoutManager(new LinearLayoutManager(getContext(), LinearLayoutManager.HORIZONTAL, false));
            breakingNewsRecyclerView.setAdapter(breakingNewsAdapter);

            // Popular News RecyclerView (Grid)
            popularNewsRecyclerView = binding.popularNewsRecyclerView;
            popularNewsList = new ArrayList<>();
            newsAdapter = new NewsAdapter(popularNewsList, new NewsAdapter.OnItemClickListener() {
                @Override
                public void onItemClick(Article article) {
                    openArticleDetail(article);
                }

                @Override
                public void onBookmarkClick(Article article, int position) {
                    // Toggle bookmark state locally first for immediate feedback
                    boolean isBookmarked = article.isBookmarked();
                    article.setBookmarked(!isBookmarked);
                    newsAdapter.notifyItemChanged(position);
                    
                    // Call bookmark API
                    if (newsRepository != null) {
                        if (!isBookmarked) {
                            // Add bookmark
                            newsRepository.bookmarkArticle(article.getId(), new NewsRepository.RepositoryCallback<JSONObject>() {
                                @Override
                                public void onResult(com.example.newsapplication.api.ApiResponse<JSONObject> response) {
                                    if (!response.isSuccess()) {
                                        // Revert if API call fails
                                        article.setBookmarked(false);
                                        newsAdapter.notifyItemChanged(position);
                                        android.util.Log.e("HomeFragment", "Failed to bookmark article: " + response.getErrorMessage());
                                    }
                                }
                            });
                        } else {
                            // Remove bookmark
                            newsRepository.removeBookmark(article.getId(), new NewsRepository.RepositoryCallback<JSONObject>() {
                                @Override
                                public void onResult(com.example.newsapplication.api.ApiResponse<JSONObject> response) {
                                    if (!response.isSuccess()) {
                                        // Revert if API call fails
                                        article.setBookmarked(true);
                                        newsAdapter.notifyItemChanged(position);
                                        android.util.Log.e("HomeFragment", "Failed to remove bookmark: " + response.getErrorMessage());
                                    }
                                }
                            });
                        }
                    }
                }
            });
            popularNewsRecyclerView.setLayoutManager(new GridLayoutManager(getContext(), 2));
            popularNewsRecyclerView.setAdapter(newsAdapter);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private void loadMockNews() {
        // Load only mock data for frontend-only implementation
        loadMockDataForDebugging();
        
        // Load mock data for now - API integration is ready
        
        // Helper method to create Article objects
    private com.example.newsapplication.model.Article createSimpleArticle(String id, String title, String summary, String content, 
                                              String source, String category, String author, String imageUrl, int imageResId, String date, boolean isBookmarked) {
        com.example.newsapplication.model.Article article = new com.example.newsapplication.model.Article();
        article.setId(id);
        article.setTitle(title);
        article.setDescription(summary);
        article.setContent(content);
        article.setSource(source);
        article.setCategory(category);
        article.setAuthor(author);
        article.setImageUrl(imageUrl);
        article.setImageResId(imageResId);
        article.setCreatedAt(date);
        article.setBookmarked(isBookmarked);
        return article;
    }

    private void loadArticlesFromAPI() {
        // Load mock data for now - API integration is ready
        // loadArticlesFromAPI();
        
        // Load bookmarks if user is logged in
        if (sessionManager.isLoggedIn()) {
            loadBookmarksFromAPI();
        }
    }

    private void loadMockDataForDebugging() {
        // Add test articles to verify UI works
        breakingNewsList.add(new Article(
                "debug1",
                "Test Article - Frontend Only",
                "Testing frontend-only implementation",
                "This is a test article to verify that the UI and adapters are working correctly with local resources.",
                "Debug Source",
                "Debug",
                "Test",
                null, // No imageUrl for frontend-only
                com.example.newsapplication.R.drawable.ic_launcher_foreground,
                "16/11/2025",
                false
        ));

        // Add test article to popular news
        popularNewsList.add(new Article(
                "debug2",
                "Sample Popular News Article",
                "This is a sample article in the popular news section to test the grid layout and navigation.",
                "Full content for this sample article. This should display properly when clicked and show the article detail screen with the corrected header spacing.",
                "Test News",
                "Test News",
                "Sample",
                null, // No imageUrl for frontend-only
                com.example.newsapplication.R.drawable.placeholder_image,
                "16/11/2025",
                false
        ));

        breakingNewsAdapter.notifyDataSetChanged();
        newsAdapter.notifyDataSetChanged();
    }

    private void loadArticlesFromAPI() {
        android.util.Log.d("HomeFragment", "=== Starting loadArticlesFromAPI() ===");
        
        if (newsRepository != null) {
            android.util.Log.d("HomeFragment", "Calling newsRepository.getArticles()");
            newsRepository.getArticles(new NewsRepository.RepositoryCallback<JSONObject>() {
                @Override
                public void onResult(com.example.newsapplication.api.ApiResponse<JSONObject> response) {
                    android.util.Log.d("HomeFragment", "API Response received - Success: " + response.isSuccess() + ", Data: " + (response.getData() != null ? "present" : "null"));
                    
                    if (response.isSuccess() && response.getData() != null) {
                        try {
                            // Process the articles from API response
                            android.util.Log.d("HomeFragment", "Articles loaded from API: " + response.getData().toString());
                            
                            // Parse articles array from response
                            JSONObject data = response.getData();
                            android.util.Log.d("HomeFragment", "Parsing API data: " + data.toString());
                            
                            // Try different response formats
                            org.json.JSONArray articlesArray = null;
                            if (data.has("results")) {
                                articlesArray = data.getJSONArray("results");
                                android.util.Log.d("HomeFragment", "Using 'results' array with " + articlesArray.length() + " items");
                            } else if (data.has("articles")) {
                                articlesArray = data.getJSONArray("articles");
                                android.util.Log.d("HomeFragment", "Using 'articles' array with " + articlesArray.length() + " items");
                            } else if (data.has("data")) {
                                Object dataObj = data.opt("data");
                                if (dataObj instanceof org.json.JSONArray) {
                                    articlesArray = (org.json.JSONArray) dataObj;
                                    android.util.Log.d("HomeFragment", "Using 'data' array with " + articlesArray.length() + " items");
                                } else {
                                    android.util.Log.e("HomeFragment", "Unexpected 'data' format: " + dataObj.getClass().getName());
                                }
                            }
                                
                                // Clear existing data and add from API
                                breakingNewsList.clear();
                                popularNewsList.clear();
                                
                                // Convert JSON to Article objects
                                if (articlesArray != null && articlesArray.length() > 0) {
                                    android.util.Log.d("HomeFragment", "Processing " + articlesArray.length() + " articles");
                                    for (int i = 0; i < articlesArray.length(); i++) {
                                        JSONObject articleJson = articlesArray.getJSONObject(i);
                                        Article article = parseArticleFromJson(articleJson);
                                        
                                        if (article != null) {
                                            // Add to appropriate list (first 5 to breaking, rest to popular)
                                            if (i < 5) {
                                                breakingNewsList.add(article);
                                            } else if (i < 15) {
                                                popularNewsList.add(article);
                                            }
                                        }
                                    }
                                }
                                
                                // Update UI
                                if (breakingNewsAdapter != null) {
                                    breakingNewsAdapter.notifyDataSetChanged();
                                }
                                if (newsAdapter != null) {
                                    newsAdapter.notifyDataSetChanged();
                                }
                                
                                Toast.makeText(getContext(), "Loaded " + (articlesArray != null ? articlesArray.length() : 0) + " articles from API", Toast.LENGTH_SHORT).show();
                            } else {
                                android.util.Log.e("HomeFragment", "Articles array is null or empty");
                            }
                        } catch (Exception e) {
                            android.util.Log.e("HomeFragment", "Error parsing articles: " + e.getMessage(), e);
                        }
                    } else {
                        android.util.Log.e("HomeFragment", "Failed to load articles: " + response.getErrorMessage());
                        Toast.makeText(getContext(), "Failed to load articles", Toast.LENGTH_LONG).show();
                    }
                }
            });
        }
    }
    
    private Article parseArticleFromJson(JSONObject articleJson) {
        try {
            String id = articleJson.optString("id", "");
            String title = articleJson.optString("title", "Unknown Title");
            String summary = articleJson.optString("summary", "");
            String content = articleJson.optString("content", "");
            String source = articleJson.optString("source", "Unknown Source");
            String category = articleJson.optString("category", "General");
            String author = articleJson.optString("author", "Unknown Author");
            String imageUrl = articleJson.optString("image_url", "");
            String createdAt = articleJson.optString("created_at", "");
            
            // Use placeholder image if no URL
            int imageResId = imageUrl.isEmpty() ? R.drawable.placeholder_image : R.drawable.ic_launcher_foreground;
            
            return new Article(id, title, summary, content, source, category, author, imageUrl, imageResId, createdAt, false);
        } catch (Exception e) {
            android.util.Log.e("HomeFragment", "Error parsing article: " + e.getMessage(), e);
            return null;
        }
    }

    private void loadBookmarksFromAPI() {
        if (newsRepository != null) {
            newsRepository.getBookmarks(new NewsRepository.RepositoryCallback<JSONObject>() {
                @Override
                public void onResult(com.example.newsapplication.api.ApiResponse<JSONObject> response) {
                    if (response.isSuccess() && response.getData() != null) {
                        try {
                            android.util.Log.d("HomeFragment", "Bookmarks loaded from API: " + response.getData().toString());
                            
                            // Parse bookmarks and update UI if needed
                            JSONObject data = response.getData();
                            if (data.has("results") && data.optJSONArray("results") != null) {
                                org.json.JSONArray bookmarksArray = data.getJSONArray("results");
                                android.util.Log.d("HomeFragment", "Found " + bookmarksArray.length() + " bookmarks");
                                
                                // Update bookmark status for existing articles
                                updateBookmarkStatus(bookmarksArray);
                            }
                        } catch (Exception e) {
                            android.util.Log.e("HomeFragment", "Error parsing bookmarks: " + e.getMessage(), e);
                        }
                    } else {
                        android.util.Log.e("HomeFragment", "Failed to load bookmarks: " + response.getErrorMessage());
                    }
                }
            });
        }
    }

    private void updateBookmarkStatus(org.json.JSONArray bookmarksArray) {
        try {
            // Create a set of bookmarked article IDs
            java.util.Set<String> bookmarkedIds = new java.util.HashSet<>();
            for (int i = 0; i < bookmarksArray.length(); i++) {
                JSONObject bookmark = bookmarksArray.getJSONObject(i);
                String articleId = bookmark.optString("article_id", "");
                if (!articleId.isEmpty()) {
                    bookmarkedIds.add(articleId);
                }
            }
            
            // Update bookmark status for articles in current lists
            for (Article article : breakingNewsList) {
                if (bookmarkedIds.contains(article.getId())) {
                    article.setBookmarked(true);
                }
            }
            
            for (Article article : popularNewsList) {
                if (bookmarkedIds.contains(article.getId())) {
                    article.setBookmarked(true);
                }
            }
            
            // Refresh adapters
            if (breakingNewsAdapter != null) {
                breakingNewsAdapter.notifyDataSetChanged();
            }
            if (newsAdapter != null) {
                newsAdapter.notifyDataSetChanged();
            }
            
        } catch (Exception e) {
            android.util.Log.e("HomeFragment", "Error updating bookmark status: " + e.getMessage(), e);
        }
    }

    private void loadBreakingNews() {
        // Load breaking news from mock data provider
        if (mockDataProvider != null) {
            List<Article> articles = mockDataProvider.getBreakingNews();
            breakingNewsList.clear();
            breakingNewsList.addAll(articles.subList(0, Math.min(10, articles.size())));
            breakingNewsAdapter.notifyDataSetChanged();
        }
    }

    private void loadPopularNews() {
        // Load popular news from mock data provider
        if (mockDataProvider != null) {
            List<Article> articles = mockDataProvider.getPopularNews();
            popularNewsList.clear();
            popularNewsList.addAll(articles.subList(0, Math.min(20, articles.size())));
            newsAdapter.notifyDataSetChanged();
        }
    }

    public void switchToSource(String source) {
        // For frontend-only implementation, source switching is handled by different mock data
        this.currentSource = source;
        loadPopularNews();
    }

    private void openArticleDetail(Article article) {
        try {
            if (getContext() != null) {
                Intent intent = new Intent(getContext(), ArticleDetailActivity.class);
                intent.putExtra("article", article);
                startActivity(intent);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private void parseArticleFromJson(JSONObject articleJson) {
        try {
            String id = articleJson.optString("id", "");
            String title = articleJson.optString("title", "Unknown Title");
            String summary = articleJson.optString("summary", "");
            String content = articleJson.optString("content", "");
            String source = articleJson.optString("source", "Unknown Source");
            String category = articleJson.optString("category", "General");
            String author = articleJson.optString("author", "Unknown Author");
            String imageUrl = articleJson.optString("image_url", "");
            String createdAt = articleJson.optString("created_at", "");
            
            // Use placeholder image if no URL
            int imageResId = imageUrl.isEmpty() ? R.drawable.placeholder_image : R.drawable.ic_launcher_foreground;
            
            return new Article(id, title, summary, content, source, category, author, imageUrl, imageResId, createdAt, false);
        } catch (Exception e) {
            android.util.Log.e("HomeFragment", "Error parsing article: " + e.getMessage(), e);
            return null;
        }
    }

    @Override
    public void onDestroyView() {
        super.onDestroyView();
        binding = null;
        // No RSS service to shutdown in frontend-only implementation
    }
}